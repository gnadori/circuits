<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Agon - Javított Verzió</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; margin: 0; padding: 20px; }
        #status { margin-bottom: 15px; font-size: 1.5em; font-weight: bold; background: white; padding: 10px 30px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s; }
        #game-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); position: relative; }
        svg { width: 600px; height: 600px; cursor: pointer; }
        
        /* Pálya színei */
        .hex { stroke: #444; stroke-width: 0.5; }
        .ring-6 { fill: #d1d8e0; } .ring-5 { fill: #a5b1c2; } .ring-4 { fill: #778ca3; }
        .ring-3 { fill: #4b6584; } .ring-2 { fill: #2d98da; } .ring-1 { fill: #45aaf2; }
        .throne { fill: #f1c40f; stroke: #d35400; stroke-width: 3; }

        /* Kijelölések */
        .hex.selectable { stroke: #27ae60; stroke-width: 4; filter: brightness(1.1); }
        .hex.target { stroke: #e74c3c; stroke-width: 4; stroke-dasharray: 5; }
        .hex.placement { fill: #3498db !important; stroke: white; stroke-width: 3; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Bábuk */
        .p1 { fill: #2c3e50; } .p2 { fill: #ecf0f1; stroke: #2c3e50; stroke-width: 2; }
        .crown { fill: #e67e22; }

        /* Börtön / Kiütött bábuk */
        .prison { margin-top: 20px; display: flex; gap: 20px; background: #fff; padding: 15px; border-radius: 15px; border: 2px dashed #bdc3c7; }
        .prison-box { text-align: center; min-width: 150px; }
        .prison-count { font-size: 2em; font-weight: bold; color: #e74c3c; }
        .log { margin-top: 10px; color: #c0392b; font-weight: bold; height: 1.5em; }
    </style>
</head>
<body>

    <div id="status">Sötét következik</div>
    
    <div id="game-container">
        <svg id="board" viewBox="0 0 800 800"></svg>
    </div>

    <div id="message-log" class="log"></div>

    <div class="prison">
        <div class="prison-box">
            <div>Sötét kiütött bábui:</div>
            <div id="p1-prison" class="prison-count">0</div>
        </div>
        <div class="prison-box">
            <div>Világos kiütött bábui:</div>
            <div id="p2-prison" class="prison-count">0</div>
        </div>
    </div>

<script>
    const svg = document.getElementById('board');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('message-log');
    
    const R = 35, W = Math.sqrt(3) * R, H = 2 * R, CENTER = 400;
    
    let turn = 1, selectedHex = null, gameState = {}, capturedPool = { 1: [], 2: [] };

    function createBoard() {
        for (let q = -6; q <= 6; q++) {
            for (let r = Math.max(-6, -q - 6); r <= Math.min(6, -q + 6); r++) {
                const x = CENTER + W * (q + r/2), y = CENTER + (H * 3/4) * r;
                const ring = getRing(q, r);
                const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                const pts = Array.from({length:6},(_,i)=>{
                    const a=(i*60-30)*Math.PI/180; 
                    return `${x+R*Math.cos(a)},${y+R*Math.sin(a)}`;
                }).join(" ");
                hex.setAttribute("points", pts);
                hex.setAttribute("class", `hex ring-${ring} ${ring===0?'throne':''}`);
                hex.setAttribute("id", `hex-${q},${r}`);
                hex.onclick = () => handleHexClick(q, r);
                svg.appendChild(hex);
            }
        }
        setupInitialPosition();
        updateUI();
    }

    function getRing(q, r) { return Math.max(Math.abs(q), Math.abs(r), Math.abs(-q-r)); }

    function setupInitialPosition() {
        // Sötét (P1)
        gameState["0,-6"] = {p: 1, t: 'q'};
        [[-2,-4], [-4,-2], [-6,0], [2,-6], [4,-6], [6,-6]].forEach(pos => gameState[pos.join(',')] = {p:1, t:'g'});
        // Világos (P2)
        gameState["0,6"] = {p: 2, t: 'q'};
        [[-2,6], [-4,6], [-6,6], [2,4], [4,2], [6,0]].forEach(pos => gameState[pos.join(',')] = {p:2, t:'g'});
    }

    function updateUI() {
        document.querySelectorAll('.piece-ui').forEach(p => p.remove());
        document.querySelectorAll('.hex').forEach(h => h.classList.remove('selectable', 'target', 'placement'));

        // Bábuk rajzolása
        for (const [id, piece] of Object.entries(gameState)) {
            const [q, r] = id.split(',').map(Number);
            const x = CENTER + W * (q + r/2), y = CENTER + (H * 3/4) * r;
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", "piece-ui");
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx", x); c.setAttribute("cy", y);
            c.setAttribute("r", piece.t === 'q' ? R*0.7 : R*0.5);
            c.setAttribute("class", `p${piece.p}`);
            g.appendChild(c);
            if(piece.t === 'q') {
                const crown = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                crown.setAttribute("cx", x); crown.setAttribute("cy", y); crown.setAttribute("r", R*0.2);
                crown.setAttribute("class", "crown"); g.appendChild(crown);
            }
            svg.appendChild(g);
        }

        // Állapot frissítése
        document.getElementById('p1-prison').innerText = capturedPool[1].length;
        document.getElementById('p2-prison').innerText = capturedPool[2].length;

        if (capturedPool[turn].length > 0) {
            const pToPlace = capturedPool[turn][0];
            statusDiv.innerText = `${turn===1?'Sötét':'Világos'}: Tedd vissza a ${pToPlace.t==='q'?'Királynőt':'Őrt'}!`;
            statusDiv.style.color = "#3498db";
            showPlacementOptions(pToPlace);
        } else {
            statusDiv.innerText = `${turn===1?'Sötét':'Világos'} következik`;
            statusDiv.style.color = "#2c3e50";
            for (const [id, piece] of Object.entries(gameState)) {
                if (piece.p === turn) document.getElementById(`hex-${id}`).classList.add('selectable');
            }
        }
    }

    function showPlacementOptions(piece) {
        document.querySelectorAll('.hex').forEach(hex => {
            const [q, r] = hex.id.replace('hex-','').split(',').map(Number);
            if (!gameState[`${q},${r}`] && getRing(q, r) !== 0) {
                if (piece.t === 'q' || getRing(q, r) === 6) hex.classList.add('placement');
            }
        });
    }

    function handleHexClick(q, r) {
        const id = `${q},${r}`;
        
        // Ha visszahelyezés van
        if (capturedPool[turn].length > 0) {
            if (document.getElementById(`hex-${id}`).classList.contains('placement')) {
                gameState[id] = capturedPool[turn].shift();
                logDiv.innerText = "";
                nextTurn();
            }
            return;
        }

        // Normál lépés
        if (selectedHex) {
            if (isValid(selectedHex.q, selectedHex.r, q, r)) {
                executeMove(selectedHex.q, selectedHex.r, q, r);
            } else {
                selectedHex = null;
                handleHexClick(q, r);
            }
        } else if (gameState[id] && gameState[id].p === turn) {
            selectedHex = {q, r};
            highlightTargets(q, r);
        }
    }

    function highlightTargets(q, r) {
        document.querySelectorAll('.hex').forEach(h => h.classList.remove('target'));
        [[1,0], [-1,0], [0,1], [0,-1], [-1,1], [1,-1]].forEach(d => {
            if (isValid(q, r, q+d[0], r+d[1])) {
                const el = document.getElementById(`hex-${q+d[0]},${r+d[1]}`);
                if (el) el.classList.add('target');
            }
        });
    }

    function isValid(q1, r1, q2, r2) {
        if (gameState[`${q2},${r2}`]) return false;
        const ring1 = getRing(q1, r1), ring2 = getRing(q2, r2);
        const dist = Math.max(Math.abs(q1-q2), Math.abs(r1-r2), Math.abs((-q1-r1)-(-q2-r2)));
        if (dist !== 1) return false;
        if (ring2 === 0 && gameState[`${q1},${r1}`].t !== 'q') return false;
        return ring2 <= ring1;
    }

    function executeMove(q1, r1, q2, r2) {
        gameState[`${q2},${r2}`] = gameState[`${q1},${r1}`];
        delete gameState[`${q1},${r1}`];
        checkCaptures(q2, r2);
        nextTurn();
    }

    function checkCaptures(q, r) {
        const p = gameState[`${q},${r}`].p;
        [[1,0], [-1,0], [0,1], [0,-1], [-1,1], [1,-1]].forEach(d => {
            const eq = q+d[0], er = r+d[1];
            if (gameState[`${eq},${er}`] && gameState[`${eq},${er}`].p !== p) {
                const fq = eq+d[0], fr = er+d[1];
                if (gameState[`${fq},${fr}`] && gameState[`${fq},${fr}`].p === p) {
                    const victim = gameState[`${eq},${er}`];
                    delete gameState[`${eq},${er}`];
                    capturedPool[victim.p].push(victim);
                    capturedPool[victim.p].sort((a,b) => a.t === 'q' ? -1 : 1);
                    logDiv.innerText = "Bábu kiütve! Visszahelyezés következik.";
                }
            }
        });
    }

    function nextTurn() {
        selectedHex = null;
        turn = turn === 1 ? 2 : 1;
        updateUI();
        checkWinner();
    }

    function checkWinner() {
        const t = gameState["0,0"];
        if (t && t.t === 'q') {
            const count = [[1,0], [-1,0], [0,1], [0,-1], [-1,1], [1,-1]].filter(d => {
                const pc = gameState[`${d[0]},${d[1]}`];
                return pc && pc.p === t.p && pc.t === 'g';
            }).length;
            if (count === 6) { alert(`A ${t.p===1?'Sötét':'Világos'} játékos nyert!`); location.reload(); }
        }
    }

    createBoard();
</script>
</body>
</html>
